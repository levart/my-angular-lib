{"version":3,"file":"build-graph.js","sourceRoot":"","sources":["../../../../src/lib/graph/build-graph.ts"],"names":[],"mappings":";;;AACA,+CAAkD;AAqBlD;;;GAGG;AACH,MAAa,UAAU;IAAvB;QACU,UAAK,GAAG,IAAI,GAAG,EAAgB,CAAC;IAmF1C,CAAC;IAhFQ,GAAG,CAAC,KAAoB;QAC7B,IAAI,KAAK,YAAY,KAAK,EAAE,CAAC;YAC3B,KAAK,MAAM,IAAI,IAAI,KAAK,EAAE,CAAC;gBACzB,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;YACpB,CAAC;QACH,CAAC;aAAM,CAAC;YACN,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QACrB,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAEO,MAAM,CAAC,IAAU;QACvB,IAAI,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC;YAC7B,+BAA+B;YAC/B,MAAM,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YACzC,OAAO,CAAC,YAAY,CAAC,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;QACxC,CAAC;QAED,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;YACjB,MAAM,OAAO,GAAG,IAAA,mBAAW,EAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YACtC,IAAI,OAAO,EAAE,CAAC;gBACZ,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;YAC5B,CAAC;QACH,CAAC;QAED,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;IACjC,CAAC;IAEM,GAAG,CAAC,GAAW;QACpB,OAAO,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;IAC7B,CAAC;IAEM,GAAG,CAAC,GAAW;QACpB,OAAO,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;IAC7B,CAAC;IAEM,OAAO;QACZ,OAAO,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC,CAAC;IACzC,CAAC;IAEM,MAAM;QACX,OAAO,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC;IAC7B,CAAC;IAEM,IAAI,CAAwB,EAA6B;QAC9D,KAAK,MAAM,IAAI,IAAI,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE,EAAE,CAAC;YACvC,IAAI,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC;gBACb,OAAO,IAAI,CAAC;YACd,CAAC;QACH,CAAC;QAED,OAAO,KAAK,CAAC;IACf,CAAC;IAEM,MAAM,CAAwB,EAA6B;QAChE,MAAM,MAAM,GAAQ,EAAE,CAAC;QAEvB,KAAK,MAAM,IAAI,IAAI,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE,EAAE,CAAC;YACvC,IAAI,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC;gBACb,MAAM,CAAC,IAAI,CAAC,IAAS,CAAC,CAAC;YACzB,CAAC;QACH,CAAC;QAED,OAAO,MAAM,CAAC;IAChB,CAAC;IAEM,IAAI,CAAwB,EAA6B;QAC9D,KAAK,MAAM,IAAI,IAAI,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE,EAAE,CAAC;YACvC,IAAI,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC;gBACb,OAAO,IAAS,CAAC;YACnB,CAAC;QACH,CAAC;QAED,OAAO,SAAS,CAAC;IACnB,CAAC;IAED,IAAI,IAAI;QACN,OAAO,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC;IACzB,CAAC;CACF;AApFD,gCAoFC","sourcesContent":["import { FSWatcher } from 'chokidar';\nimport { fileUrlPath } from '../ng-package/nodes';\nimport { Node } from './node';\n\nexport type SimplePredicate<T = Node> = {\n  (value: T): boolean;\n  and?: (criteria: SimplePredicate<T>) => SimplePredicate<T>;\n};\n\nexport type ComplexPredicate<T = Node, R extends T = T> =\n  | SimplePredicate<T>\n  | {\n      (value: T): value is R;\n      and?: (criteria: ComplexPredicate<T, R>) => ComplexPredicate<T, R>;\n    };\n\nexport interface Traversable<T> {\n  filter<R extends T = T>(by: ComplexPredicate<T, R>): R[];\n  find<R extends T = T>(by: ComplexPredicate<T, R>): R | undefined;\n  some(by: SimplePredicate<T>): boolean;\n}\n\n/**\n * A tree of source files. Eventually, it's a graph. Ideally, it's an acyclic directed graph.\n * Technically, it's implemented as a map-like collection with references between map entries.\n */\nexport class BuildGraph implements Traversable<Node> {\n  private store = new Map<string, Node>();\n  watcher?: FSWatcher;\n\n  public put(value: Node | Node[]) {\n    if (value instanceof Array) {\n      for (const node of value) {\n        this.insert(node);\n      }\n    } else {\n      this.insert(value);\n    }\n\n    return this;\n  }\n\n  private insert(node: Node) {\n    if (this.store.has(node.url)) {\n      // Clean up dependee references\n      const oldNode = this.store.get(node.url);\n      oldNode['_dependees'].delete(oldNode);\n    }\n\n    if (this.watcher) {\n      const fileUrl = fileUrlPath(node.url);\n      if (fileUrl) {\n        this.watcher.add(fileUrl);\n      }\n    }\n\n    this.store.set(node.url, node);\n  }\n\n  public get(url: string): Node {\n    return this.store.get(url);\n  }\n\n  public has(url: string): boolean {\n    return this.store.has(url);\n  }\n\n  public entries(): Node[] {\n    return Array.from(this.store.values());\n  }\n\n  public values(): IterableIterator<Node> {\n    return this.store.values();\n  }\n\n  public some<T extends Node = Node>(by: ComplexPredicate<Node, T>): boolean {\n    for (const node of this.store.values()) {\n      if (by(node)) {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  public filter<T extends Node = Node>(by: ComplexPredicate<Node, T>): T[] {\n    const result: T[] = [];\n\n    for (const node of this.store.values()) {\n      if (by(node)) {\n        result.push(node as T);\n      }\n    }\n\n    return result;\n  }\n\n  public find<T extends Node = Node>(by: ComplexPredicate<Node, T>): T | undefined {\n    for (const node of this.store.values()) {\n      if (by(node)) {\n        return node as T;\n      }\n    }\n\n    return undefined;\n  }\n\n  get size(): number {\n    return this.store.size;\n  }\n}\n"]}